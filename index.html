<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heart Rain â†’ Name</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#fff;
}
canvas{
  position:fixed;
  inset:0;
}
</style>
</head>

<body>
<canvas id="canvas"></canvas>

<script>
/* ================= CONFIG ================= */
const NAME_TEXT = "DUYÃŠN";
const RAIN_TIME = 2000;
const NAME_TIME = 4000;
const IS_MOBILE = innerWidth < 768;
const TOTAL_HEARTS = IS_MOBILE ? 850 : 1400;

/* ================= CANVAS ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const DPR = Math.min(devicePixelRatio||1,2);

/* ================= OFFSCREEN ================= */
const off = document.createElement("canvas");
const offCtx = off.getContext("2d",{willReadFrequently:true});
let targets=[];

function resize(){
  canvas.width = innerWidth * DPR;
  canvas.height = innerHeight * DPR;
  canvas.style.width = innerWidth+"px";
  canvas.style.height = innerHeight+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
resize();
addEventListener("resize",resize);

const rand=(a,b)=>Math.random()*(b-a)+a;

/* ================= DRAW HEART ================= */
function drawHeart(x,y,s,c){
  ctx.fillStyle=c;
  ctx.beginPath();
  ctx.moveTo(x,y+s/4);
  ctx.bezierCurveTo(x+s,y-s/2,x+s*1.4,y+s/3,x,y+s);
  ctx.bezierCurveTo(x-s*1.4,y+s/3,x-s,y-s/2,x,y+s/4);
  ctx.fill();
}

/* ================= HEART DATA ================= */
const hearts=[];
for(let i=0;i<TOTAL_HEARTS;i++){
  hearts.push({
    x:rand(0,innerWidth),
    y:rand(-innerHeight,innerHeight),
    vx:0,
    vy:rand(28,65),
    size:rand(IS_MOBILE?3:4, IS_MOBILE?5:6),
    color:`hsl(${rand(330,360)},75%,60%)`,
    tx:0,
    ty:0
  });
}

/* ================= BUILD NAME (Xáº¾P NGANG CHO Cáº¢ MOBILE) ================= */
function buildNameTargets(text){
  off.width = innerWidth;
  off.height = innerHeight;
  offCtx.clearRect(0,0,off.width,off.height);

  const fs = IS_MOBILE
    ? Math.min(innerWidth * 0.14, innerHeight * 0.14)
    : Math.min(innerWidth * 0.18, innerHeight * 0.22);

  offCtx.font = `900 ${fs}px Arial`;
  offCtx.textBaseline="middle";
  offCtx.textAlign="left";

  targets=[];

  let total = 0;
  for(const c of text) total += offCtx.measureText(c).width;

  let x = off.width/2 - total/2;
  const y = off.height/2;

  for(let i=0;i<text.length;i++){
    offCtx.clearRect(0,0,off.width,off.height);
    offCtx.fillText(text[i], x, y);
    grab();
    x += offCtx.measureText(text[i]).width;
  }
}

function grab(){
  const step = IS_MOBILE ? 6 : 5;
  const d = offCtx.getImageData(0,0,off.width,off.height).data;
  for(let y=0;y<off.height;y+=step){
    for(let x=0;x<off.width;x+=step){
      if(d[(y*off.width+x)*4+3]>20){
        targets.push({x,y});
      }
    }
  }
}

/* ================= EMOJI ORBIT ================= */
let emojiAngle = 0;
const emojiList = ["ðŸ’–","ðŸ’•","ðŸ’—"];

function drawEmojiOrbit(){
  const cx = innerWidth/2;
  const cy = innerHeight/2;

  const radius = IS_MOBILE
    ? Math.min(innerWidth,innerHeight) * 0.28
    : Math.min(innerWidth,innerHeight) * 0.34;

  ctx.font = IS_MOBILE ? "18px serif" : "20px serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  const icon = emojiList[Math.floor(Date.now()/800)%emojiList.length];
  const count = IS_MOBILE ? 10 : 12;

  for(let i=0;i<count;i++){
    const a = emojiAngle + (Math.PI*2/count)*i;
    ctx.fillText(
      icon,
      cx + Math.cos(a)*radius,
      cy + Math.sin(a)*radius
    );
  }

  emojiAngle += IS_MOBILE ? 0.006 : 0.008;
}

/* ================= STATE ================= */
let state="rain";
let stateTime=performance.now();

function switchState(next){
  state=next;
  stateTime=performance.now();

  if(state==="rain"){
    for(const h of hearts){
      h.vx=0;
      h.vy=rand(28,65);
    }
  }

  if(state==="name"){
    for(const h of hearts){
      const p = targets[(Math.random()*targets.length)|0];
      h.tx=p.x;
      h.ty=p.y;
    }
  }
}

/* ================= LOOP ================= */
function animate(now){
  const e=now-stateTime;

  if(state==="rain" && e>RAIN_TIME){
    buildNameTargets(NAME_TEXT);
    switchState("name");
  }

  if(state==="name" && e>NAME_TIME){
    switchState("rain");
  }

  ctx.fillStyle = state==="name" ? "#ffe6ef" : "#ffffff";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  /* ===== EMOJI ORBIT (CHá»ˆ KHI NAME) ===== */
  if(state==="name"){
    drawEmojiOrbit();
  }

  for(const h of hearts){
    if(state==="name"){
      h.vx+=(h.tx-h.x)*0.05;
      h.vy+=(h.ty-h.y)*0.05;
      h.vx*=0.82;
      h.vy*=0.82;
      h.x+=h.vx;
      h.y+=h.vy;
    }else{
      h.y+=h.vy*0.016;
      if(h.y>innerHeight){
        h.y=-20;
        h.x=rand(0,innerWidth);
      }
    }
    drawHeart(h.x,h.y,h.size,h.color);
  }

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
</script>
</body>
</html>
